<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LightTouch Preview</title>
  <style>
    :root{
      --bg:#f4f5f7; --panel:#fff; --text:#111; --muted:#6b7280; --border:#dfe1e6; --accent:#0067ff;
      --canvas-bg:#fff; --canvas-shadow:0 1px 3px rgba(0,0,0,.08), 0 8px 24px rgba(0,0,0,.06);
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    header{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:16px;margin:0;font-weight:600;letter-spacing:.2px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .group{display:flex;gap:6px;align-items:center;padding:6px 8px;background:#fafafa;border:1px solid var(--border);border-radius:10px}
    label{font-size:12px;color:var(--muted)}
    select,button,a.button{
      cursor:pointer;background:var(--panel);color:var(--text);
      border:1px solid var(--border);border-radius:8px;padding:6px 10px;text-decoration:none
    }
    button:hover,a.button:hover,select:hover{background:#f1f3f5}
    .pane{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .pane header{padding:10px 12px;border-bottom:1px solid var(--border);margin:0;background:#fafafa}
    .pane header h2{margin:0;font-size:12px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted)}
    /* Email canvas wrapper */
    .canvasWrap{display:flex;justify-content:center;padding:24px; background:var(--bg)}
    .emailCanvas{
      background:var(--canvas-bg);
      box-shadow:var(--canvas-shadow);
      border:1px solid var(--border);
      width:700px; /* default, JS will update */
    }
    #frame{width:100%;min-height:400px;border:0;display:block;background:white}
    #src{width:100%;min-height:120px;background:#fafafa;color:var(--text);border:0;padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .hidden{display:none}
    .tip{color:var(--muted);font-size:12px;margin-top:6px;padding:0 12px 12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="title">LightTouch Preview</h1>
      <div class="controls">
        <div class="group">
          <label for="widthSel">Width</label>
          <select id="widthSel">
            <option value="320">320 (small)</option>
            <option value="375">375 (iPhone)</option>
            <option value="414">414 (large phone)</option>
            <option value="600">600 (classic email)</option>
            <option value="700" selected>700</option>
            <option value="800">800</option>
          </select>
          <label for="bgSel">Background</label>
          <select id="bgSel">
            <option value="inbox" selected>Inbox grey</option>
            <option value="white">White</option>
          </select>
        </div>
        <button id="toggleSource" title="Show/Hide source">View source</button>
        <button id="copyBtn" title="Copy HTML to clipboard">Copy HTML</button>
        <button id="downloadBtn" title="Download as .html">Download</button>
        <a id="openRaw" class="button" href="#" target="_blank" rel="noopener">Open raw</a>
      </div>
    </header>

    <div class="pane">
      <header><h2>Preview</h2></header>
      <div class="canvasWrap" id="canvasWrap">
        <div class="emailCanvas" id="emailCanvas">
          <iframe id="frame" sandbox="allow-forms allow-popups allow-same-origin"></iframe>
        </div>
      </div>
    </div>

    <div id="sourcePane" class="pane hidden" style="margin-top:12px;">
      <header><h2>Source</h2></header>
      <textarea id="src" spellcheck="false"></textarea>
      <div class="tip">Params: <code>?html=</code> (URL-encoded) or <code>?src=</code> (URL to .html). Optional <code>&b64=1</code>, <code>&title=</code>. Width/background are UI only.</div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const byId = id => document.getElementById(id);
    const frame = byId('frame'), srcTA = byId('src');
    const widthSel = byId('widthSel'), bgSel = byId('bgSel');
    const emailCanvas = byId('emailCanvas'), canvasWrap = byId('canvasWrap');

    function setTitle(){
      const t = qs.get('title');
      if (t){ byId('title').textContent = t; document.title = t + ' â€¢ LightTouch'; }
    }

    function setWidth(w){ emailCanvas.style.width = (w || 700) + 'px'; resizeFrame(); }
    function setBackground(mode){
      if (mode === 'white'){ canvasWrap.style.background = '#fff'; }
      else { canvasWrap.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg'); }
    }

    function decodeInput(){
      let html = qs.get('html');
      const b64 = qs.get('b64') === '1';
      const from = qs.get('src');

      setTitle();

      if (from) return fetchSource(from);
      if (html){
        try { html = b64 ? atob(html) : decodeURIComponent(html); } catch(e){}
        return Promise.resolve(html);
      }

      const placeholder = `<!doctype html><html><head><meta charset="utf-8"><meta name=viewport content="width=device-width"><title>LightTouch placeholder</title><style>body{font:16px/1.5 system-ui;max-width:720px;margin:2rem auto;padding:0 1rem;color:#222}code{background:#f4f6f8;padding:.2em .35em;border-radius:6px}</style></head><body><h2>It works.</h2><p>Pass your HTML via <code>?html=</code> (URL-encoded) or <code>?src=</code> (URL). Optional <code>&b64=1</code>, <code>&title=</code>.</p><p>Example:<br><code>?title=Email%20Preview&html=%3Ch1%3EHello%20world%3C%2Fh1%3E</code></p></body></html>`;
      return Promise.resolve(placeholder);
    }

    async function fetchSource(u){
      try{
        const res = await fetch(u, { mode:'cors' });
        return await res.text();
      }catch(e){
        return `<!doctype html><meta charset=utf-8><style>body{font:16px system-ui;padding:2rem}</style><h2>Could not fetch <code>${u.replace(/</g,'&lt;')}</code></h2><p>${e.message}</p><p>Ensure the source allows CORS.</p>`;
      }
    }

    function render(html){
      srcTA.value = html;
      frame.srcdoc = html;
      resizeFrame();

      const blob = new Blob([html], { type: 'text/html' });
      byId('openRaw').href = URL.createObjectURL(blob);
    }

    function resizeFrame(){
      requestAnimationFrame(() => {
        try{
          const doc = frame.contentDocument;
          const adjust = () => frame.style.height = Math.max(300, doc.documentElement.scrollHeight, doc.body?.scrollHeight || 0) + 'px';
          doc.addEventListener('load', adjust, true);
          adjust();
        }catch(e){ frame.style.height = '800px'; }
      });
    }

    // UI events
    byId('toggleSource').addEventListener('click', () => byId('sourcePane').classList.toggle('hidden'));
    byId('copyBtn').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(srcTA.value); toast('Copied'); } catch { toast('Copy failed'); }
    });
    byId('downloadBtn').addEventListener('click', () => {
      const a = document.createElement('a');
      a.download = (qs.get('title') || 'preview') + '.html';
      a.href = byId('openRaw').href;
      a.click();
    });
    widthSel.addEventListener('change', e => setWidth(parseInt(e.target.value,10)));
    bgSel.addEventListener('change', e => setBackground(e.target.value));

    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      t.style.cssText = 'position:fixed;right:12px;bottom:12px;background:#111;color:#fff;padding:8px 10px;border-radius:10px;opacity:.96;z-index:9999';
      document.body.appendChild(t); setTimeout(()=>t.remove(),1200);
    }

    // Initial
    setWidth(parseInt(widthSel.value,10));
    setBackground(bgSel.value);
    decodeInput().then(render);
  </script>
</body>
</html>
